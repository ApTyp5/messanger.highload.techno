Курсовой проект "мессенджер"
==========

Задача: 
---------
1. Определить примерное количество пользователей.
2. Определить планируемые (пиковые) нагрузки на сервис.
3. Составить логическую схему базы данных для MVP


Аудитория: 
---------
50 млн человек по России [(половина пользователей телеграмма 4 года назад)](https://telegram.org/blog/100-million)

Планируемые нагрузки:
----------------
[100 миллионов пользователей](https://telegram.org/blog/100-million) были способны создавать нагрузку в 
[15 биллионов запросов](https://telegram.org/blog/15-billion) в сутки

Следовательно для 50 млн пользователей нагрузка будет равна 
(15 * 10^9) / 2 = __7.5 * 10^9 (request per day)__

Но нагрузка распределена не равномерно, в соответствии со [статистикой](https://popsters.ru/blog/post/aktivnost-auditorii-v-socialnyh-setyah-issledovanie-2019) 
в пиковый час телеграм обрабаывает 4,5 % дневного трафика.

Следовательно, в пик нагрузки сервису приходится обрабаывать 
(7.5 * 10^9 * 4,5%) / 100% = __3 375 * 10^5 (rph)__

Предположив,что в течение часа/минуты нагрузка распределяется равномерно, расчитаем более точную нагрузку на сервис: 
```
  3 375 * 10^5 (request per hour) =
  = 56,25 * 10^5 (rpm) =
  = 93,75 * 10^3 (rps)
```

Учитывая, что для MVP релаизация чатов не потребуется, то траффик можно разделить на 2 равных составляюих: 

1. Отправка сообщений (93,75 / 2 * 10^3) = 46,875 * 10^3 ~= 47 * 10^3
2. Запрос на уведомления ~= 47 * 10^3

Схема бд:
--------------------
![Схема бд](https://github.com/ApTyp5/messanger.highload.techno/blob/main/photo_2020-11-15_13-25-00.jpg)


Выбор конкретной СУБД
-----------------------------
В качестве СУБД выбрана MongoDB благодаря следующим характеристикам:
1. Репликация из коробки;
2. Мастабируемость из коробки;
3. Большое количество хорошей документации;
3. Низкий порог входа ([легко настраивать](https://github.com/ApTyp5/messanger.highload.techno/blob/main/MongoDB_Architecture_Guide.pdf)).


Идея функционирования сервиса:
--------------------
1. Обращения к таблицам пользователей и чатов происходят не часто, поэтому подробно рассматриваться не будут.
2. Основная функциональность (отправка сообщений и запрос на уведомления) будут реализовываться при помощи таблицы сообщений.
3. Отправка сообщений есть вставка новой записи в таблицу сообщений.
4. Запрос уведомлений есть считывание сообщений чата chat_id начиная со времени timestamp (последняя метрика хранится на клиенте).


Подсчет выдерживаемой нагрузки при *отправке сообщений* (то есть при вставке нового документа в базу):
--------------------------


Шардинг
----------------------------
Шардинг в MongoDB состоит из:
1. Серверов конфигураций (их должно быть 3 штуки, подробно рассматриваться не будут);
2. Шардов (подробости рассмотрены далее);
3. Клиентских демонов (по демону на каждый app-server, он действует в качестве роутера между шардами);

Шардинг будет производиться по полю chat_id, количество шардов будет вычислено далее. 
Данне в шардах можно разделять на чанки (например по 10 чатов на 1 чанк). Они при неравномерном
занимаемом пространстве автоматически балансироваться между шардами.

Репликация
----------------------------
В MongoDB репликация доступна каждому шару из коробки (обычно для одного шарда держат 2-3 реплики).



